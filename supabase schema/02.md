-- ============================================
-- 01_tables.sql
-- Haupttabellen: Projekte, Seiten, Keywords, SERP, Tasks, Content usw.
-- ============================================


-- =======================
-- üü£ PROJECTS (Multi-Tenant)
-- =======================
CREATE TABLE IF NOT EXISTS projects (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,
  name TEXT NOT NULL,
  domain TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);


-- =======================
-- üü¶ PAGES (Crawled Data)
-- =======================
CREATE TABLE IF NOT EXISTS pages (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,

  url TEXT NOT NULL,
  title TEXT,
  content_hash TEXT,
  crawled_at TIMESTAMPTZ,

  technical_data JSONB,
  semantic_data JSONB,
  internal_links JSONB,

  embedding VECTOR(1536),

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

  UNIQUE(project_id, url)
);


-- =======================
-- üü® INTERNAL LINKS
-- =======================
CREATE TABLE IF NOT EXISTS internal_links (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,

  from_page BIGINT REFERENCES pages(id) ON DELETE CASCADE,
  to_page   BIGINT REFERENCES pages(id) ON DELETE SET NULL,

  anchor TEXT,

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);


-- =======================
-- üü© KEYWORDS
-- =======================
CREATE TABLE IF NOT EXISTS keywords (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,

  keyword TEXT NOT NULL,
  search_volume INTEGER,
  keyword_difficulty INTEGER,
  cpc NUMERIC,
  intent TEXT,

  semrush_data JSONB,

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

  UNIQUE(project_id, keyword)
);


-- =======================
-- üü© SEMANTIC CLUSTERS
-- =======================
CREATE TABLE IF NOT EXISTS semantic_clusters (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  name TEXT NOT NULL UNIQUE,
  description TEXT,

  embedding VECTOR(1536),

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);


-- =======================
-- üîó KEYWORD ‚Üî CLUSTER (M:N)
-- =======================
CREATE TABLE IF NOT EXISTS keyword_clusters (
  keyword_id BIGINT REFERENCES keywords(id) ON DELETE CASCADE,
  cluster_id BIGINT REFERENCES semantic_clusters(id) ON DELETE RESTRICT,
  PRIMARY KEY(keyword_id, cluster_id)
);


-- =======================
-- üîó PAGE ‚Üî KEYWORDS (M:N)
-- =======================
CREATE TABLE IF NOT EXISTS page_keywords (
  page_id BIGINT REFERENCES pages(id) ON DELETE CASCADE,
  keyword_id BIGINT REFERENCES keywords(id) ON DELETE CASCADE,
  PRIMARY KEY(page_id, keyword_id)
);


-- =======================
-- üì° SERP RESULTS (DataForSEO)
-- =======================
CREATE TABLE IF NOT EXISTS serp_results (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  keyword_id BIGINT REFERENCES keywords(id) ON DELETE CASCADE,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,

  raw_json JSONB NOT NULL,
  device TEXT,
  location TEXT,
  language TEXT,

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  
  collected_date DATE DEFAULT CURRENT_DATE,

  UNIQUE(keyword_id, collected_date, device, location, language)
);


-- =======================
-- üîç COMPETITOR ANALYSIS
-- =======================
CREATE TABLE IF NOT EXISTS competitor_analysis (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  serp_result_id BIGINT REFERENCES serp_results(id) ON DELETE CASCADE,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,

  competitor_url TEXT NOT NULL,

  title TEXT,
  headings JSONB,
  topics JSONB,
  entities JSONB,

  word_count INTEGER,
  raw_json JSONB,

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);


-- =======================
-- üü´ CONTENT TASKS (AI Writer Queue)
-- =======================
CREATE TABLE IF NOT EXISTS content_tasks (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  keyword_id BIGINT REFERENCES keywords(id) ON DELETE SET NULL,

  task_type task_type DEFAULT 'article',
  status task_status DEFAULT 'pending',

  suggested_title TEXT,
  suggested_outline JSONB,
  search_intent TEXT,

  priority INTEGER DEFAULT 0,
  impact_score INTEGER,
  quality_score INTEGER,

  notes TEXT,

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);


-- =======================
-- üü´ GENERATED CONTENT
-- =======================
CREATE TABLE IF NOT EXISTS generated_content (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  task_id BIGINT REFERENCES content_tasks(id) ON DELETE SET NULL,
  keyword_id BIGINT REFERENCES keywords(id) ON DELETE SET NULL,

  title TEXT,
  meta_description TEXT,
  slug TEXT,
  h1 TEXT,

  content_html TEXT,
  content_json JSONB,

  external_links JSONB,
  internal_links JSONB,

  embedding VECTOR(1536),

  version INTEGER DEFAULT 1,
  parent_id BIGINT REFERENCES generated_content(id) ON DELETE SET NULL,

  status content_status DEFAULT 'draft',

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

  UNIQUE(project_id, slug)
);


-- =======================
-- üßæ SLUG HISTORY
-- =======================
CREATE TABLE IF NOT EXISTS slug_history (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  generated_content_id BIGINT REFERENCES generated_content(id) ON DELETE CASCADE,

  old_slug TEXT NOT NULL,
  new_slug TEXT,

  redirect_type redirect_type DEFAULT '301',

  changed_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);


-- =======================
-- üìä CONTENT PERFORMANCE
-- =======================
CREATE TABLE IF NOT EXISTS content_performance (
  id BIGSERIAL PRIMARY KEY,
  uuid UUID DEFAULT uuid_generate_v4() UNIQUE,

  generated_content_id BIGINT REFERENCES generated_content(id) ON DELETE CASCADE,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,

  clicks INTEGER,
  impressions INTEGER,
  avg_position NUMERIC,
  ctr NUMERIC,

  engagement_score NUMERIC,

  source perf_source DEFAULT 'GSC',

  raw_json JSONB,

  collected_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
