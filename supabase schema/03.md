-- ============================================
-- 02_indexes_triggers.sql
-- Indexe + Trigger fÃ¼r optimale Performance
-- ============================================


-- =======================
-- ðŸ“Œ Indexe â€“ Projects
-- =======================
CREATE INDEX IF NOT EXISTS projects_uuid_idx
  ON projects(uuid);


-- =======================
-- ðŸ“Œ Indexe â€“ Pages
-- =======================
CREATE INDEX IF NOT EXISTS pages_project_id_idx
  ON pages(project_id);

CREATE INDEX IF NOT EXISTS pages_embedding_idx
  ON pages USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

CREATE INDEX IF NOT EXISTS pages_technical_data_gin
  ON pages USING gin (technical_data);


-- =======================
-- ðŸ“Œ Indexe â€“ Internal Links
-- =======================
CREATE INDEX IF NOT EXISTS internal_links_project_idx
  ON internal_links(project_id);

CREATE INDEX IF NOT EXISTS internal_links_from_page_idx
  ON internal_links(from_page);

CREATE INDEX IF NOT EXISTS internal_links_to_page_idx
  ON internal_links(to_page);


-- =======================
-- ðŸ“Œ Indexe â€“ Keywords
-- =======================
CREATE INDEX IF NOT EXISTS keywords_project_idx
  ON keywords(project_id);

CREATE INDEX IF NOT EXISTS keywords_keyword_lower_idx
  ON keywords (lower(keyword));

CREATE INDEX IF NOT EXISTS keywords_semrush_data_gin
  ON keywords USING gin (semrush_data);


-- =======================
-- ðŸ“Œ Indexe â€“ Keyword Clusters
-- =======================
-- (PrimÃ¤rschlÃ¼ssel reicht, keine zusÃ¤tzlichen Indexe notwendig)


-- =======================
-- ðŸ“Œ Indexe â€“ Page Keywords
-- =======================
CREATE INDEX IF NOT EXISTS page_keywords_keyword_idx
  ON page_keywords(keyword_id);

CREATE INDEX IF NOT EXISTS page_keywords_page_idx
  ON page_keywords(page_id);


-- =======================
-- ðŸ“Œ Indexe â€“ Semantic Clusters
-- =======================
CREATE INDEX IF NOT EXISTS semantic_clusters_embedding_idx
  ON semantic_clusters USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);


-- =======================
-- ðŸ“Œ Indexe â€“ SERP Results
-- =======================
CREATE INDEX IF NOT EXISTS serp_results_keyword_idx
  ON serp_results(keyword_id);

CREATE INDEX IF NOT EXISTS serp_results_project_idx
  ON serp_results(project_id);

CREATE INDEX IF NOT EXISTS serp_results_rawjson_gin
  ON serp_results USING gin(raw_json);

CREATE INDEX IF NOT EXISTS serp_results_collected_date_idx
  ON serp_results(keyword_id, collected_date, device, location, language);


-- =======================
-- ðŸ“Œ Indexe â€“ Competitor Analysis
-- =======================
CREATE INDEX IF NOT EXISTS competitor_analysis_serp_idx
  ON competitor_analysis(serp_result_id);

CREATE INDEX IF NOT EXISTS competitor_analysis_project_idx
  ON competitor_analysis(project_id);

CREATE INDEX IF NOT EXISTS competitor_analysis_rawjson_gin
  ON competitor_analysis USING gin(raw_json);


-- =======================
-- ðŸ“Œ Indexe â€“ Content Tasks
-- =======================
CREATE INDEX IF NOT EXISTS content_tasks_project_idx
  ON content_tasks(project_id);

CREATE INDEX IF NOT EXISTS content_tasks_status_idx
  ON content_tasks(status);

CREATE INDEX IF NOT EXISTS content_tasks_priority_idx
  ON content_tasks(priority);


-- =======================
-- ðŸ“Œ Indexe â€“ Generated Content
-- =======================
CREATE INDEX IF NOT EXISTS generated_content_project_idx
  ON generated_content(project_id);

CREATE INDEX IF NOT EXISTS generated_content_status_idx
  ON generated_content(status);

CREATE INDEX IF NOT EXISTS generated_content_embedding_idx
  ON generated_content USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

CREATE INDEX IF NOT EXISTS generated_content_content_json_gin
  ON generated_content USING gin(content_json);


-- =======================
-- ðŸ“Œ Indexe â€“ Slug History
-- =======================
CREATE INDEX IF NOT EXISTS slug_history_project_idx
  ON slug_history(project_id);


-- =======================
-- ðŸ“Œ Indexe â€“ Content Performance
-- =======================
CREATE INDEX IF NOT EXISTS content_performance_generated_idx
  ON content_performance(generated_content_id);

CREATE INDEX IF NOT EXISTS content_performance_project_idx
  ON content_performance(project_id);

CREATE INDEX IF NOT EXISTS content_performance_rawjson_gin
  ON content_performance USING gin(raw_json);


-- ============================================
-- ðŸ”¥ TRIGGER: updated_at auto-update
-- ============================================

CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;


-- Helper function to safely recreate triggers
CREATE OR REPLACE FUNCTION recreate_trigger_if_missing(
  tbl TEXT,
  trg TEXT
)
RETURNS VOID AS $$
BEGIN
  IF NOT EXISTS (
      SELECT 1 FROM information_schema.triggers
      WHERE event_object_table = tbl AND trigger_name = trg
  ) THEN
    EXECUTE 'CREATE TRIGGER ' || trg ||
            ' BEFORE UPDATE ON ' || tbl ||
            ' FOR EACH ROW EXECUTE FUNCTION set_updated_at();';
  END IF;
END;
$$ LANGUAGE plpgsql;


-- Apply triggers to all relevant tables
SELECT recreate_trigger_if_missing('projects', 'trg_projects');
SELECT recreate_trigger_if_missing('pages', 'trg_pages');
SELECT recreate_trigger_if_missing('keywords', 'trg_keywords');
SELECT recreate_trigger_if_missing('content_tasks', 'trg_tasks');
SELECT recreate_trigger_if_missing('generated_content', 'trg_generated');
SELECT recreate_trigger_if_missing('serp_results', 'trg_serp');
SELECT recreate_trigger_if_missing('competitor_analysis', 'trg_competitor');
SELECT recreate_trigger_if_missing('content_performance', 'trg_perf');
