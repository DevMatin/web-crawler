-- ============================================
-- 04_notify_webhooks.sql
-- Automatische Trigger + pg_notify für n8n / Worker
-- ============================================


-- =======================
-- 1) FUNCTION: notify_new_task()
-- =======================
-- Diese Funktion feuert, wenn ein neuer Task erstellt wird.
-- Sie sendet alle relevanten Daten an den Channel "new_content_task".
-- n8n kann diesen Channel als Trigger verwenden.

CREATE OR REPLACE FUNCTION notify_new_task()
RETURNS trigger AS $$
DECLARE
    payload JSON;
    project_uuid_text TEXT;
BEGIN
    -- Projekt-UUID laden (public)
    SELECT uuid INTO project_uuid_text
    FROM projects
    WHERE id = NEW.project_id;

    -- JSON-Payload erzeugen (für Webhook oder n8n Listener)
    payload := json_build_object(
        'task_id',       NEW.id,
        'task_uuid',     NEW.uuid::text,
        'project_id',    NEW.project_id,
        'project_uuid',  project_uuid_text,
        'keyword_id',    NEW.keyword_id,
        'task_type',     NEW.task_type,
        'status',        NEW.status,
        'priority',      NEW.priority,
        'created_at',    NEW.created_at
    );

    -- PostgreSQL-Event senden
    PERFORM pg_notify('new_content_task', payload::text);

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


-- =======================
-- 2) Trigger sauber & idempotent erstellen
-- =======================

DO $$
BEGIN
    -- Falls alter Trigger existiert → löschen (für Idempotenz)
    IF EXISTS (
        SELECT 1 FROM information_schema.triggers
        WHERE trigger_name = 'trigger_notify_task'
          AND event_object_table = 'content_tasks'
    ) THEN
        EXECUTE 'DROP TRIGGER trigger_notify_task ON content_tasks;';
    END IF;

    -- Neuen Trigger sauber anlegen
    EXECUTE '
        CREATE TRIGGER trigger_notify_task
        AFTER INSERT ON content_tasks
        FOR EACH ROW
        EXECUTE FUNCTION notify_new_task();
    ';
END$$;


-- ============================================
-- Hinweis: n8n Listener Beispiel
-- ============================================
-- In n8n → "Postgres Trigger Node" konfigurieren:
--
--  Client: Supabase Postgres URL
--  Channel: new_content_task
--
-- Dann kannst du NEW TASK events wie Webhooks empfangen:
--   $json.task_uuid
--   $json.project_uuid
--   $json.keyword_id
--   $json.task_type
--
-- und damit direkt:
--   - Crawling starten
--   - SERP/DataForSEO starten
--   - Content Writing Workflow starten
--   - usw.
